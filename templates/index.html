<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>rentfaster - Find Your Perfect Rental</title>
    
    <!-- Leaflet Map Library -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 50%, #fce7f3 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 20px;
            align-items: start;
        }

        .content-area {
            min-width: 0;
        }

        .filters-sidebar {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        /* Responsive layout for mobile */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .main-layout {
                grid-template-columns: 1fr;
            }
            
            .filters-sidebar {
                position: relative;
                top: 0;
                max-height: none;
                margin-bottom: 20px;
            }
            
            header {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .subtitle {
                font-size: 0.95em;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 1.5em;
            }
        }

        h1 {
            color: #00a389;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 400;
        }
        
        h1 .brand-fast {
            font-style: italic;
            font-weight: 300;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00a389;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9em;
        }

        .filters {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .filter-operator {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .operator-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .operator-option:hover {
            background: white;
        }

        .operator-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .operator-option label {
            cursor: pointer;
            font-weight: 600;
            color: #555;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .filter-group select[multiple] {
            min-height: 120px;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #00a389;
        }

        .multi-select-info {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .active-filters-badge {
            background: #00a389;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .filter-section {
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
        }

        .filter-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-section-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .clear-section-btn {
            padding: 5px 12px;
            background: #e9ecef;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
            color: #6c757d;
        }

        .clear-section-btn:hover {
            background: #dc3545;
            color: white;
        }

        .filter-input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .clear-filter-btn {
            padding: 4px 8px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            font-size: 0.75em;
            cursor: pointer;
            transition: all 0.2s;
            color: #6c757d;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .clear-filter-btn:hover {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
            border-color: #dc3545;
        }

        .operator-toggle {
            display: inline-flex;
            background: #fff;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
            margin-left: 10px;
        }

        .operator-toggle input[type="radio"] {
            display: none;
        }

        .operator-toggle label {
            padding: 4px 12px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            color: #6c757d;
            border-right: 1px solid #e0e0e0;
            margin: 0;
            font-weight: 600;
        }

        .operator-toggle label:last-child {
            border-right: none;
        }

        .operator-toggle input[type="radio"]:checked + label {
            background: #00a389;
            color: white;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #00a389;
            color: white;
        }

        .btn-primary:hover {
            background: #008c74;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 163, 137, 0.4);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #d0d0d0;
        }

        .results {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .results-count {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .sort-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .sort-controls select {
            padding: 8px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
        }

        .listings-grid {
            display: grid;
            gap: 20px;
        }

        .listing-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            display: grid;
            grid-template-columns: 150px 1fr auto;
            gap: 20px;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .listing-card:hover {
            border-color: #00a389;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .listing-image {
            width: 150px;
            height: 150px;
            border-radius: 10px;
            object-fit: cover;
            background: #e0e0e0;
        }

        .listing-details {
            flex: 1;
        }

        .listing-title {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .listing-address {
            color: #666;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .listing-specs {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .spec {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #555;
            font-size: 0.95em;
        }

        .spec-icon {
            font-weight: bold;
            color: #00a389;
        }

        .listing-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }

        .tag-immediate {
            background: #dcfce7;
            color: #16a34a;
        }

        .tag-pet {
            background: #fef3c7;
            color: #d97706;
        }

        .tag-value {
            background: #dbeafe;
            color: #2563eb;
        }

        .listing-price {
            text-align: right;
            display: flex;
            flex-direction: column;
            justify-content: center;
            gap: 10px;
        }

        .price-main {
            font-size: 2em;
            font-weight: bold;
            color: #00a389;
        }

        .price-detail {
            color: #666;
            font-size: 0.9em;
        }

        .view-btn {
            padding: 10px 20px;
            background: #00a389;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            display: inline-block;
            text-align: center;
            transition: all 0.3s;
        }

        .view-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1em;
        }

        .no-results {
            text-align: center;
            padding: 60px;
            color: #999;
        }

        .no-results-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .listing-card {
                grid-template-columns: 1fr;
            }

            .listing-price {
                text-align: left;
            }

            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                padding: 15px;
            }
            
            .action-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                width: 100%;
                padding: 15px;
            }
            
            .filter-section {
                padding: 15px;
            }
            
            .operator-toggle {
                flex-wrap: wrap;
            }
            
            .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .listing-image {
                height: 200px;
            }
            
            .filter-input-wrapper {
                flex-direction: column;
            }
            
            .clear-filter-btn {
                width: 100%;
                margin-top: 5px;
            }
        }

        /* Map Filter Styles */
        .map-filter-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .map-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .map-filter-header h3 {
            color: #00a389;
            font-size: 1.3em;
        }

        .map-toggle-btn {
            background: #00a389;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .map-toggle-btn:hover {
            background: #5568d3;
        }

        #map {
            height: 400px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        #map.active {
            display: block;
        }

        .map-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .radius-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .radius-control label {
            font-weight: 500;
            color: #333;
        }

        .radius-control input[type="range"] {
            width: 200px;
        }

        .radius-value {
            background: #00a389;
            color: white;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: bold;
            min-width: 70px;
            text-align: center;
        }

        .clear-location-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .clear-location-btn:hover {
            background: #b91c1c;
        }

        .location-info {
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            padding: 10px;
            border-radius: 5px;
            color: #0369a1;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>rent<span class="brand-fast">faster</span></h1>
            <p class="subtitle">Explore <span id="total-count">0</span> rental listings across all cities</p>
            <button onclick="toggleDebugPanel()" style="margin-top: 15px; padding: 10px 20px; background: #00a389; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px;">
                üêõ Debug Info
            </button>
        </header>
        
        <!-- Debug Panel -->
        <div id="debug-panel" style="display: none; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-bottom: 30px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: #00a389;">üìä Dataset Diagnostics</h2>
                <button onclick="toggleDebugPanel()" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">Close</button>
            </div>
            
            <div id="debug-content">
                <p style="text-align: center; color: #666;">Loading debug information...</p>
            </div>
        </div>

        <div class="stats-grid" id="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="stat-avg-price">...</div>
                <div class="stat-label">Average Rent</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-avg-size">...</div>
                <div class="stat-label">Avg Size (sq ft)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-avg-cost">...</div>
                <div class="stat-label">Avg $/sq ft</div>
            </div>
            <div class="stat-card" title="Listings with 'Immediate' availability out of total listings">
                <div class="stat-value">
                    <span id="stat-immediate">...</span>
                    <span style="font-size: 0.5em; color: #999;"> / <span id="stat-total-inline">...</span></span>
                </div>
                <div class="stat-label">Available Now</div>
                <div style="font-size: 0.75em; color: #666; margin-top: 5px;">
                    üìÖ <span id="stat-percentage">...</span> dispon√≠vel imediatamente
                </div>
            </div>
        </div>

        <div style="background: #f0f9ff; padding: 12px 20px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
            <div style="font-size: 0.9em; color: #1e40af;">
                <strong>üí° Sobre os n√∫meros:</strong> 
                Existem <strong><span id="help-total">6,811</span> listings totais</strong> no banco de dados. 
                Destes, <strong><span id="help-immediate">4,803</span> (<span id="help-percentage">71%</span>)</strong> est√£o dispon√≠veis imediatamente. 
                Os demais t√™m datas futuras espec√≠ficas (ex: December 01, January 01, etc.) ou disponibilidade negoci√°vel.
            </div>
        </div>

        <!-- Main Layout: Filters Sidebar + Content -->
        <div class="main-layout">
            <!-- Filters Sidebar (Left) -->
            <div class="filters-sidebar">
        <div class="filters">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin: 0; color: #00a389;">üîç Filtros</h2>
                <button class="btn btn-secondary" onclick="clearAllFilters()" style="padding: 8px 20px;">
                    üóëÔ∏è Limpar Todos os Filtros
                </button>
            </div>

            <!-- Map Location Filter -->
            <div class="map-filter-container">
                <div class="map-filter-header">
                    <h3>üìç Filtro por Localiza√ß√£o</h3>
                    <button class="map-toggle-btn" onclick="toggleMap()">
                        <span id="map-toggle-text">Mostrar Mapa</span>
                    </button>
                </div>
                
                <div id="map"></div>
                
                <div class="map-controls">
                    <div class="radius-control">
                        <label for="radius-slider">Raio:</label>
                        <input type="range" id="radius-slider" min="0.5" max="20" step="0.5" value="5">
                        <span class="radius-value"><span id="radius-value">5</span> km</span>
                    </div>
                    <button class="clear-location-btn" onclick="clearLocationFilter()" style="display: none;" id="clear-location-btn">
                        ‚úñ Limpar Localiza√ß√£o
                    </button>
                </div>
                
                <div id="location-info" class="location-info" style="display: none; margin-top: 15px;">
                    üí° <strong>Dica:</strong> Clique no mapa para definir um ponto de refer√™ncia. Os im√≥veis dentro do raio selecionado ser√£o mostrados.
                </div>
            </div>

            <!-- Search Filter Section -->
            <div class="filter-section">
                <div class="filter-section-header">
                    <div class="filter-section-title">
                        üîç Busca por Nome
                    </div>
                    <button class="clear-section-btn" onclick="clearSearchFilter()">üóëÔ∏è Limpar</button>
                </div>
                <div class="filter-group">
                    <label for="filter-search">Nome do Pr√©dio / T√≠tulo</label>
                    <div class="filter-input-wrapper">
                        <input 
                            type="text" 
                            id="filter-search" 
                            placeholder="Ex: Country Village, Executive Infill..."
                            style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
                        >
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-search')" title="Limpar busca">‚úï</button>
                    </div>
                    <div class="multi-select-info" style="margin-top: 5px;">
                        Digite para buscar no t√≠tulo/nome do im√≥vel
                    </div>
                </div>
            </div>

            <!-- City Filter Section -->
            <div class="filter-section">
                <div class="filter-section-header">
                    <div class="filter-section-title">
                        üèôÔ∏è Filtro por Cidade
                    </div>
                    <button class="clear-section-btn" onclick="clearCityFilter()">üóëÔ∏è Limpar</button>
                </div>
                <div class="filter-group">
                    <label>
                        Cidades
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="city-and" name="city-operator" value="AND" checked>
                            <label for="city-and">AND</label>
                            <input type="radio" id="city-or" name="city-operator" value="OR">
                            <label for="city-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-city" multiple style="flex: 1;">
                            <option value="calgary">Calgary</option>
                            <option value="edmonton">Edmonton</option>
                            <option value="toronto">Toronto</option>
                            <option value="ottawa">Ottawa</option>
                            <option value="mississauga">Mississauga</option>
                            <option value="winnipeg">Winnipeg</option>
                            <option value="vancouver">Vancouver</option>
                            <option value="brampton">Brampton</option>
                            <option value="airdrie">Airdrie</option>
                            <option value="london">London</option>
                            <option value="saskatoon">Saskatoon</option>
                            <option value="regina">Regina</option>
                            <option value="cochrane">Cochrane</option>
                            <option value="victoria">Victoria</option>
                            <option value="chestermere">Chestermere</option>
                            <option value="kitchener">Kitchener</option>
                            <option value="leduc">Leduc</option>
                            <option value="st. albert">St. Albert</option>
                            <option value="fort saskatchewan">Fort Saskatchewan</option>
                            <option value="surrey">Surrey</option>
                            <option value="waterloo">Waterloo</option>
                            <option value="beaumont">Beaumont</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-city')" title="Limpar cidades">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rias cidades</div>
                </div>
            </div>

            <!-- Basic Filters Section -->
            <div class="filter-section">
                <div class="filter-section-header">
                    <div class="filter-section-title">
                        üí∞ Filtros B√°sicos
                    </div>
                    <button class="clear-section-btn" onclick="clearBasicFilters()">üóëÔ∏è Limpar</button>
                </div>
                <div class="filter-grid">
                <div class="filter-group">
                    <label>
                        Price Range
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="price-and" name="price-operator" value="AND">
                            <label for="price-and">AND</label>
                            <input type="radio" id="price-or" name="price-operator" value="OR" checked>
                            <label for="price-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-price" multiple style="flex: 1;">
                            <option value="0-800">Under $800</option>
                            <option value="800-1000">$800 - $1,000</option>
                            <option value="1000-1200">$1,000 - $1,200</option>
                            <option value="1200-1500">$1,200 - $1,500</option>
                            <option value="1500-1800">$1,500 - $1,800</option>
                            <option value="1800-2200">$1,800 - $2,200</option>
                            <option value="2200-3000">$2,200 - $3,000</option>
                            <option value="3000-99999">$3,000+</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-price')" title="Limpar pre√ßo">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>

                <div class="filter-group">
                    <label>
                        Bedrooms
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="beds-and" name="beds-operator" value="AND">
                            <label for="beds-and">AND</label>
                            <input type="radio" id="beds-or" name="beds-operator" value="OR" checked>
                            <label for="beds-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-beds" multiple style="flex: 1;">
                            <option value="0">Bachelor</option>
                            <option value="1">1 Bedroom</option>
                            <option value="2">2 Bedrooms</option>
                            <option value="3">3 Bedrooms</option>
                            <option value="4">4+ Bedrooms</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-beds')" title="Limpar quartos">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>

                <div class="filter-group">
                    <label>
                        Size (sq ft)
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="size-and" name="size-operator" value="AND">
                            <label for="size-and">AND</label>
                            <input type="radio" id="size-or" name="size-operator" value="OR" checked>
                            <label for="size-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-size" multiple style="flex: 1;">
                            <option value="0-500">Under 500</option>
                            <option value="500-700">500 - 700</option>
                            <option value="700-900">700 - 900</option>
                            <option value="900-1100">900 - 1,100</option>
                            <option value="1100-1500">1,100 - 1,500</option>
                            <option value="1500-2000">1,500 - 2,000</option>
                            <option value="2000-99999">2,000+</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-size')" title="Limpar tamanho">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>

                <div class="filter-group">
                    <label>
                        <span id="community-label">Community (Top 30)</span>
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="community-and" name="community-operator" value="AND" checked>
                            <label for="community-and">AND</label>
                            <input type="radio" id="community-or" name="community-operator" value="OR">
                            <label for="community-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-community" multiple size="5" style="flex: 1;">
                            <option>Carregando...</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-community')" title="Limpar comunidade">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>
            </div>
            </div>

            <!-- Property Features Section -->
            <div class="filter-section">
                <div class="filter-section-header">
                    <div class="filter-section-title">
                        üè¢ Caracter√≠sticas da Propriedade
                    </div>
                    <button class="clear-section-btn" onclick="clearFeaturesFilters()">üóëÔ∏è Limpar</button>
                </div>
                <div class="filter-grid">
                <div class="filter-group">
                    <label>
                        Estacionamento
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="parking-and" name="parking-operator" value="AND">
                            <label for="parking-and">AND</label>
                            <input type="radio" id="parking-or" name="parking-operator" value="OR" checked>
                            <label for="parking-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-parking" multiple style="flex: 1;">
                            <option value="available">Com Estacionamento</option>
                            <option value="none">Sem Estacionamento</option>
                            <option value="1">1 Vaga</option>
                            <option value="2">2 Vagas</option>
                            <option value="3">3 Vagas</option>
                            <option value="4">4 Vagas</option>
                            <option value="5+">5+ Vagas</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-parking')" title="Limpar estacionamento">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>

                <div class="filter-group">
                    <label>Mobiliado</label>
                    <div class="filter-input-wrapper">
                        <select id="filter-furnished" style="flex: 1;">
                            <option value="">Todos</option>
                            <option value="yes">Mobiliado</option>
                            <option value="no">N√£o Mobiliado</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-furnished')" title="Limpar mobiliado">‚úï</button>
                    </div>
                </div>

                <div class="filter-group">
                    <label>
                        Carpete (Carpet)
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="carpet-and" name="carpet-operator" value="AND">
                            <label for="carpet-and">AND</label>
                            <input type="radio" id="carpet-or" name="carpet-operator" value="OR" checked>
                            <label for="carpet-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-carpet" multiple style="flex: 1;">
                            <option value="with">‚úì Com Carpete (explicitamente tem)</option>
                            <option value="without">‚úó Sem Carpete (explicitamente n√£o tem)</option>
                            <option value="not-mentioned">? N√£o Mencionado (sem info)</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-carpet')" title="Limpar carpete">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>

                <div class="filter-group">
                    <label>
                        Tipo de Propriedade
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="unittype-and" name="unittype-operator" value="AND">
                            <label for="unittype-and">AND</label>
                            <input type="radio" id="unittype-or" name="unittype-operator" value="OR" checked>
                            <label for="unittype-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-unit-type" multiple style="flex: 1;">
                            <option value="Apartment">Apartment (3,746)</option>
                            <option value="Condo Unit">Condo Unit (2,298)</option>
                            <option value="House">House (1,863)</option>
                            <option value="Basement">Basement (1,799)</option>
                            <option value="Townhouse">Townhouse (1,396)</option>
                            <option value="Main Floor">Main Floor (680)</option>
                            <option value="Room For Rent">Room For Rent (515)</option>
                            <option value="Duplex">Duplex (490)</option>
                            <option value="Fourplex">Fourplex (71)</option>
                            <option value="Garage Suite">Garage Suite (37)</option>
                            <option value="Loft">Loft (27)</option>
                            <option value="Other">Other (22)</option>
                            <option value="Office Space">Office Space (22)</option>
                            <option value="Storage">Storage (19)</option>
                            <option value="Triplex">Triplex (10)</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-unit-type')" title="Limpar tipo">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>

                <div class="filter-group">
                    <label>
                        Utilidades Inclu√≠das
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="utilities-and" name="utilities-operator" value="AND" checked>
                            <label for="utilities-and">AND</label>
                            <input type="radio" id="utilities-or" name="utilities-operator" value="OR">
                            <label for="utilities-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-utilities" multiple style="flex: 1;">
                            <option value="Gas">Gas (9,672)</option>
                            <option value="Water">Water (5,384)</option>
                            <option value="Heat">Heat (5,348)</option>
                            <option value="Internet">Internet (2,863)</option>
                            <option value="Electricity">Electricity (2,209)</option>
                            <option value="Cable">Cable (1,500)</option>
                            <option value="Hydro">Hydro (250)</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-utilities')" title="Limpar utilidades">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>

                <div class="filter-group">
                    <label>
                        Comodidades
                        <div class="operator-toggle" style="display: inline-flex; margin-left: 10px;">
                            <input type="radio" id="amenities-and" name="amenities-operator" value="AND" checked>
                            <label for="amenities-and">AND</label>
                            <input type="radio" id="amenities-or" name="amenities-operator" value="OR">
                            <label for="amenities-or">OR</label>
                        </div>
                    </label>
                    <div class="filter-input-wrapper">
                        <select id="filter-amenities" multiple size="5" style="flex: 1;">
                            <option value="Laundry">Laundry (9,016)</option>
                            <option value="Dishwasher">Dishwasher (6,784)</option>
                            <option value="Pool">Pool (5,755)</option>
                            <option value="Security">Security (5,116)</option>
                            <option value="Storage">Storage (4,531)</option>
                            <option value="Balcony">Balcony (4,138)</option>
                            <option value="Air Conditioning">Air Conditioning (3,127)</option>
                            <option value="Patio">Patio (2,618)</option>
                            <option value="Elevator">Elevator (2,430)</option>
                            <option value="Fitness">Fitness (1,796)</option>
                            <option value="Gym">Gym (965)</option>
                            <option value="Bike Room">Bike Room (949)</option>
                            <option value="Concierge">Concierge (754)</option>
                        </select>
                        <button class="clear-filter-btn" onclick="clearIndividualFilter('filter-amenities')" title="Limpar comodidades">‚úï</button>
                    </div>
                    <div class="multi-select-info">Ctrl/Cmd + clique para selecionar v√°rios</div>
                </div>
            </div>
            </div>

            <!-- Quick Filters Section -->
            <div class="filter-section">
                <div class="filter-section-header">
                    <div class="filter-section-title">
                        ‚ö° Filtros R√°pidos (todos devem ser atendidos)
                    </div>
                    <button class="clear-section-btn" onclick="clearQuickFilters()">üóëÔ∏è Limpar</button>
                </div>
                <div class="checkbox-group">
                    <label>
                        <input type="checkbox" id="filter-immediate" checked>
                        Immediate Availability
                    </label>
                    <label>
                        <input type="checkbox" id="filter-pets">
                        Pet Friendly
                    </label>
                    <label>
                        <input type="checkbox" id="filter-value">
                        Best Value (&lt;$1.50/sq ft)
                    </label>
                    <label>
                        <input type="checkbox" id="filter-long-term" checked>
                        Long Term Lease
                    </label>
                </div>
            </div>

            <!-- Saved Filters Section -->
            <div class="filter-section" style="border-top: 2px solid #dee2e6; padding-top: 20px; margin-top: 20px;">
                <div class="filter-section-header">
                    <div class="filter-section-title">
                        üíæ Filtros Salvos
                    </div>
                </div>
                
                <!-- Save Current Filter -->
                <div class="filter-group" style="margin-bottom: 15px;">
                    <label for="save-filter-name">Salvar Filtro Atual</label>
                    <div class="filter-input-wrapper">
                        <input 
                            type="text" 
                            id="save-filter-name" 
                            placeholder="Nome do filtro..."
                            style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;"
                        >
                        <button class="clear-section-btn" onclick="saveCurrentFilter()" style="background: #28a745; color: white; border-color: #28a745;">
                            üíæ Salvar
                        </button>
                    </div>
                </div>

                <!-- Load Saved Filter -->
                <div class="filter-group">
                    <label for="saved-filters-dropdown">Carregar Filtro Salvo</label>
                    <div class="filter-input-wrapper">
                        <select id="saved-filters-dropdown" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px;" onchange="loadSavedFilter()">
                            <option value="">-- Selecione um filtro --</option>
                        </select>
                        <button class="clear-filter-btn" onclick="deleteSavedFilter()" title="Deletar filtro selecionado" style="background: #dc3545; color: white; border-color: #dc3545;">
                            üóëÔ∏è
                        </button>
                    </div>
                    <div class="multi-select-info" id="saved-filters-count" style="margin-top: 5px;">
                        Nenhum filtro salvo
                    </div>
                </div>
            </div>

            <div class="action-buttons" style="justify-content: space-between;">
                <span id="active-filters-badge" class="active-filters-badge" style="display: none;"></span>
                <div style="font-size: 0.9em; color: #666;">
                    ‚ö° Filtros aplicados automaticamente
                </div>
            </div>
        </div><!-- end filters -->

        </div><!-- end filters-sidebar -->

            <!-- Content Area (Right) -->
            <div class="content-area">
                <!-- Results will go here -->
                <div class="results-header">
                    <div class="results-info">
                        Found <span id="results-count">0</span> listings
                    </div>
                    <div class="sort-controls">
                        <label>Sort by:</label>
                        <select id="sort-by">
                            <option value="cost_asc">Best Value ($/sq ft)</option>
                            <option value="price_asc">Price: Low to High</option>
                            <option value="price_desc">Price: High to Low</option>
                            <option value="size_desc">Size: Largest First</option>
                            <option value="size_asc">Size: Smallest First</option>
                            <option value="distance_asc">Distance: Nearest First</option>
                            <option value="date_desc">Newest First</option>
                        </select>
                    </div>
                </div>

                <!-- Debug Panel -->
                <div id="debug-panel" style="display: none; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong>üîç Debug Panel</strong>
                        <button onclick="document.getElementById('debug-panel').style.display='none'" style="background: none; border: none; font-size: 1.2em; cursor: pointer;">‚úñ</button>
                    </div>
                    <div style="margin-bottom: 10px;">
                        <label><strong>Test Listing ID:</strong></label>
                        <input type="text" id="test-listing-id" placeholder="Enter listing ID (e.g., 659073)" style="width: 200px; padding: 5px; margin: 0 10px;">
                        <button onclick="testListingById()" style="padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer;">Test</button>
                    </div>
                    <div id="debug-output" style="background: white; padding: 10px; border-radius: 4px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em; white-space: pre-wrap;"></div>
                </div>
                <button onclick="document.getElementById('debug-panel').style.display='block'" style="margin-bottom: 10px; padding: 8px 15px; background: #ffc107; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">
                    üîç Show Debug Panel
                </button>

                <!-- Active Filters Badge -->
                <div id="active-filters-badge" style="display: none; background: #dbeafe; color: #1e40af; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; font-weight: 500;">
                </div>

                <!-- Listings Container -->
                <div id="listings-container"></div>
            </div>
        </div><!-- end main-layout -->

    <script>
        let allListings = [];
        let filteredListings = [];
        let filterTimeout = null;

        // Map variables
        let map = null;
        let mapMarker = null;
        let mapCircle = null;
        let hoverMarker = null; // Marker for card hover
        let selectedLocation = null;
        let selectedRadius = 5; // km

        // Load data on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadListings();
            initMap();
        });

        // Debounced version of applyFilters for better performance
        function applyFiltersDebounced() {
            clearTimeout(filterTimeout);
            
            // Show updating indicator
            const count = document.getElementById('results-count');
            count.style.opacity = '0.5';
            
            filterTimeout = setTimeout(() => {
                applyFilters();
                count.style.opacity = '1';
            }, 150); // Wait 150ms after last change
        }

        // Extract parking info from text fields if parking_spots is not set
        function enrichParkingData(listings) {
            listings.forEach(listing => {
                // If parking_spots is already set, keep it
                if (listing.parking_spots) {
                    return;
                }

                // Try to extract from title, intro, or description
                const title = (listing.title || '').toLowerCase();
                const intro = (listing.intro || '').toLowerCase();
                const fullDesc = (listing.full_description || '').toLowerCase();
                const combined = `${title} ${intro} ${fullDesc}`;

                // Look for patterns like "2 parking", "1 stall", "underground parking", etc.
                const patterns = [
                    /(\d+)\s*parking\s*(?:spot|stall|space)?s?/i,
                    /(\d+)\s*(?:parking|stall|space)s?/i,
                    /parking\s*(?:spot|stall|space)?s?\s*(?:included|available).*?(\d+)/i,
                    /(\d+)\s*underground\s*parking/i,
                    /(\d+)\s*titled\s*parking/i
                ];

                for (const pattern of patterns) {
                    const match = combined.match(pattern);
                    if (match) {
                        const parkingCount = parseInt(match[1]);
                        if (parkingCount > 0 && parkingCount < 100) { // Sanity check
                            listing.parking_spots = parkingCount;
                            listing._parking_from_text = true; // Mark it as extracted
                            break;
                        }
                    }
                }

                // If no number found but parking is mentioned, set to 1
                if (!listing.parking_spots && /\b(parking|stall|garage)\b/i.test(combined)) {
                    // Check if it explicitly says "no parking"
                    if (!/no\s*parking|without\s*parking/i.test(combined)) {
                        listing.parking_spots = 1;
                        listing._parking_from_text = true;
                    }
                }
            });
        }

        async function loadListings() {
            try {
                const response = await fetch('/api/listings');
                allListings = await response.json();
                
                // Enrich parking data from text fields
                enrichParkingData(allListings);
                
                filteredListings = allListings;
                updateStats(allListings);
                populateCommunities(allListings);
                setupAutoFilters();
                applyFilters();
            } catch (error) {
                console.error('Error loading listings:', error);
                document.getElementById('listings-container').innerHTML = 
                    '<div class="no-results"><div class="no-results-icon">‚ö†Ô∏è</div><h2>Error loading listings</h2></div>';
            }
        }

        function setupAutoFilters() {
            // Add event listeners to all filter elements for automatic filtering
            // Search input with debounce
            document.getElementById('filter-search').addEventListener('input', applyFiltersDebounced);
            
            // Using debounced version for select elements that might change rapidly
            document.getElementById('filter-city').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-price').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-beds').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-size').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-community').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-parking').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-furnished').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-carpet').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-unit-type').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-utilities').addEventListener('change', applyFiltersDebounced);
            document.getElementById('filter-amenities').addEventListener('change', applyFiltersDebounced);
            
            // Checkboxes and radio buttons apply instantly
            document.getElementById('filter-immediate').addEventListener('change', applyFilters);
            document.getElementById('filter-pets').addEventListener('change', applyFilters);
            document.getElementById('filter-value').addEventListener('change', applyFilters);
            
            // Operators for each filter
            document.getElementById('city-and').addEventListener('change', applyFilters);
            document.getElementById('city-or').addEventListener('change', applyFilters);
            document.getElementById('price-and').addEventListener('change', applyFilters);
            document.getElementById('price-or').addEventListener('change', applyFilters);
            document.getElementById('beds-and').addEventListener('change', applyFilters);
            document.getElementById('beds-or').addEventListener('change', applyFilters);
            document.getElementById('size-and').addEventListener('change', applyFilters);
            document.getElementById('size-or').addEventListener('change', applyFilters);
            document.getElementById('community-and').addEventListener('change', applyFilters);
            document.getElementById('community-or').addEventListener('change', applyFilters);
            document.getElementById('parking-and').addEventListener('change', applyFilters);
            document.getElementById('parking-or').addEventListener('change', applyFilters);
            document.getElementById('utilities-and').addEventListener('change', applyFilters);
            document.getElementById('utilities-or').addEventListener('change', applyFilters);
            document.getElementById('amenities-and').addEventListener('change', applyFilters);
            document.getElementById('amenities-or').addEventListener('change', applyFilters);
            document.getElementById('unittype-and').addEventListener('change', applyFilters);
            document.getElementById('unittype-or').addEventListener('change', applyFilters);
            document.getElementById('carpet-and').addEventListener('change', applyFilters);
            document.getElementById('carpet-or').addEventListener('change', applyFilters);
            
            document.getElementById('sort-by').addEventListener('change', applyFilters);
        }

        // Map Functions
        function initMap() {
            // Initialize map centered on Calgary
            map = L.map('map').setView([51.0447, -114.0719], 11);
            
            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add click event to map
            map.on('click', function(e) {
                setLocationMarker(e.latlng.lat, e.latlng.lng);
            });

            // Radius slider event
            document.getElementById('radius-slider').addEventListener('input', function(e) {
                selectedRadius = parseFloat(e.target.value);
                document.getElementById('radius-value').textContent = selectedRadius;
                if (selectedLocation && mapCircle) {
                    mapCircle.setRadius(selectedRadius * 1000); // Convert km to meters
                    applyFilters();
                }
            });
        }

        function toggleMap() {
            const mapElement = document.getElementById('map');
            const toggleText = document.getElementById('map-toggle-text');
            const locationInfo = document.getElementById('location-info');
            
            if (mapElement.classList.contains('active')) {
                mapElement.classList.remove('active');
                toggleText.textContent = 'Mostrar Mapa';
                locationInfo.style.display = 'none';
            } else {
                mapElement.classList.add('active');
                toggleText.textContent = 'Ocultar Mapa';
                locationInfo.style.display = 'block';
                // Refresh map size after showing
                setTimeout(() => map.invalidateSize(), 100);
            }
        }

        function setLocationMarker(lat, lng) {
            // Remove existing marker and circle
            if (mapMarker) {
                map.removeLayer(mapMarker);
            }
            if (mapCircle) {
                map.removeLayer(mapCircle);
            }

            // Set new location
            selectedLocation = { lat, lng };

            // Calculate and cache distance for all listings
            allListings.forEach(listing => {
                if (listing.latitude && listing.longitude) {
                    listing._distance = calculateDistance(lat, lng, listing.latitude, listing.longitude);
                } else {
                    listing._distance = 999999; // No coordinates
                }
            });

            // Add marker
            mapMarker = L.marker([lat, lng]).addTo(map);

            // Add circle showing radius
            mapCircle = L.circle([lat, lng], {
                color: '#00a389',
                fillColor: '#00a389',
                fillOpacity: 0.2,
                radius: selectedRadius * 1000 // Convert km to meters
            }).addTo(map);

            // Show clear button
            document.getElementById('clear-location-btn').style.display = 'block';

            // Update info
            const locationInfo = document.getElementById('location-info');
            locationInfo.innerHTML = `üìç <strong>Localiza√ß√£o selecionada:</strong> ${lat.toFixed(4)}, ${lng.toFixed(4)} | Raio: ${selectedRadius} km`;
            locationInfo.style.display = 'block';

            // Automatically switch to distance sorting
            const sortSelect = document.getElementById('sort-by');
            if (sortSelect.value !== 'distance_asc') {
                sortSelect.value = 'distance_asc';
            }

            // Apply filters
            applyFilters();
        }

        function clearLocationFilter() {
            // Remove marker and circle
            if (mapMarker) {
                map.removeLayer(mapMarker);
                mapMarker = null;
            }
            if (mapCircle) {
                map.removeLayer(mapCircle);
                mapCircle = null;
            }

            selectedLocation = null;

            // Clear cached distances from all listings
            allListings.forEach(listing => {
                delete listing._distance;
            });

            // Hide clear button
            document.getElementById('clear-location-btn').style.display = 'none';

            // Update info
            const locationInfo = document.getElementById('location-info');
            locationInfo.innerHTML = 'üí° <strong>Dica:</strong> Clique no mapa para definir um ponto de refer√™ncia. Os im√≥veis dentro do raio selecionado ser√£o mostrados.';

            // Apply filters
            applyFilters();
        }

        // Show hover marker on map when hovering over card
        function showHoverMarker(lat, lng, title) {
            if (!map || !lat || !lng) return;

            // Remove existing hover marker
            removeHoverMarker();

            // Create red marker for hover
            const redIcon = L.icon({
                iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });

            hoverMarker = L.marker([lat, lng], { icon: redIcon })
                .addTo(map)
                .bindPopup(title || 'Property Location')
                .openPopup();

            // Pan to marker if it's not visible
            map.panTo([lat, lng]);
        }

        // Remove hover marker from map
        function removeHoverMarker() {
            if (hoverMarker) {
                map.removeLayer(hoverMarker);
                hoverMarker = null;
            }
        }

        // Calculate distance between two points using Haversine formula
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance in km
        }

        function populateCommunities(listings) {
            // Count communities
            const communityCount = {};
            listings.forEach(listing => {
                const comm = listing.community;
                if (comm) {
                    communityCount[comm] = (communityCount[comm] || 0) + 1;
                }
            });

            // Sort by count and get top 30
            const topCommunities = Object.entries(communityCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 30)
                .map(([name]) => name);

            // Populate select
            const select = document.getElementById('filter-community');
            select.innerHTML = topCommunities.map(comm => 
                `<option value="${comm}">${comm} (${communityCount[comm]})</option>`
            ).join('');
        }

        function updateCommunityLabel() {
            // Count communities in filtered results
            const filteredCommunityCount = {};
            filteredListings.forEach(listing => {
                const comm = listing.community;
                if (comm) {
                    filteredCommunityCount[comm] = (filteredCommunityCount[comm] || 0) + 1;
                }
            });
            
            // Count total communities in all listings
            const totalCommunityCount = {};
            allListings.forEach(listing => {
                const comm = listing.community;
                if (comm) {
                    totalCommunityCount[comm] = (totalCommunityCount[comm] || 0) + 1;
                }
            });
            
            // Get selected communities to preserve selection
            const select = document.getElementById('filter-community');
            const selectedValues = Array.from(select.selectedOptions).map(o => o.value);
            
            // Get top 30 communities from all listings
            const topCommunities = Object.entries(totalCommunityCount)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 30)
                .map(([name]) => name);
            
            // Update select options with filtered/total counts
            select.innerHTML = topCommunities.map(comm => {
                const filteredCount = filteredCommunityCount[comm] || 0;
                const totalCount = totalCommunityCount[comm] || 0;
                const isSelected = selectedValues.includes(comm) ? 'selected' : '';
                return `<option value="${comm}" ${isSelected}>${comm} (${filteredCount}/${totalCount})</option>`;
            }).join('');
            
            // Update label with visible communities count
            const visibleCount = Object.keys(filteredCommunityCount).length;
            const label = document.getElementById('community-label');
            label.textContent = `Community (${visibleCount}/30 visible)`;
        }

        function testListingById() {
            const listingId = document.getElementById('test-listing-id').value.trim();
            const output = document.getElementById('debug-output');
            
            if (!listingId) {
                output.textContent = 'Please enter a listing ID';
                return;
            }
            
            // Find listing by ID in the link
            const listing = allListings.find(l => l.link && l.link.includes(listingId));
            
            if (!listing) {
                output.textContent = `Listing ID ${listingId} not found in dataset.\n\nTotal listings: ${allListings.length}`;
                return;
            }
            
            // Get current filter values
            const priceOptions = Array.from(document.getElementById('filter-price').selectedOptions).map(o => o.value);
            const bedsOptions = Array.from(document.getElementById('filter-beds').selectedOptions).map(o => o.value);
            const sizeOptions = Array.from(document.getElementById('filter-size').selectedOptions).map(o => o.value);
            const communityOptions = Array.from(document.getElementById('filter-community').selectedOptions).map(o => o.value);
            const parkingOptions = Array.from(document.getElementById('filter-parking').selectedOptions).map(o => o.value);
            const utilitiesOptions = Array.from(document.getElementById('filter-utilities').selectedOptions).map(o => o.value);
            const amenitiesOptions = Array.from(document.getElementById('filter-amenities').selectedOptions).map(o => o.value);
            const immediate = document.getElementById('filter-immediate').checked;
            const pets = document.getElementById('filter-pets').checked;
            const value = document.getElementById('filter-value').checked;
            const longTerm = document.getElementById('filter-long-term').checked;
            const furnished = document.getElementById('filter-furnished').value;
            
            // Test each filter
            let result = `LISTING FOUND: ${listing.title || 'No title'}\n`;
            result += `Link: ${listing.link}\n`;
            result += `\n=== LISTING DATA ===\n`;
            result += `Price: $${listing.price_avg || listing.price || 'N/A'}\n`;
            result += `Bedrooms: ${listing.beds_num || listing.beds || 'N/A'}\n`;
            result += `Size: ${listing.sqft_avg || listing.sq_feet || 'N/A'} sq ft\n`;
            result += `Community: ${listing.community || 'N/A'}\n`;
            result += `Parking: ${listing.parking_spots || 'N/A'}\n`;
            result += `Furnished: ${listing.furnished || 'N/A'}\n`;
            result += `Utilities: ${JSON.stringify(listing.utilities_included || [])}\n`;
            result += `Amenities: ${JSON.stringify(listing.amenities || [])}\n`;
            result += `Immediate Available: ${listing.immediately_available || 'N/A'}\n`;
            result += `Pet Friendly: ${listing.pet_friendly || 'N/A'}\n`;
            result += `Cost per sq ft: ${listing.cost_per_sqft || 'N/A'}\n`;
            
            result += `\n=== FILTER TESTS ===\n`;
            
            // Test price filter
            if (priceOptions.length > 0) {
                const priceMatches = priceOptions.map(range => {
                    const [min, max] = range.split('-').map(Number);
                    const match = listing.price_avg && listing.price_avg >= min && listing.price_avg <= max;
                    return `  ${range}: ${match ? '‚úì PASS' : '‚úó FAIL'}`;
                });
                result += `Price Filter (${priceOptions.length} selected):\n${priceMatches.join('\n')}\n`;
            } else {
                result += `Price Filter: ‚úì PASS (no filter)\n`;
            }
            
            // Test beds filter
            if (bedsOptions.length > 0) {
                const bedsMatches = bedsOptions.map(bedOption => {
                    const bedCount = parseInt(bedOption);
                    let match;
                    if (bedCount === 4) {
                        match = listing.beds_num && listing.beds_num >= 4;
                    } else {
                        match = listing.beds_num === bedCount;
                    }
                    return `  ${bedOption} beds: ${match ? '‚úì PASS' : '‚úó FAIL'}`;
                });
                result += `Beds Filter (${bedsOptions.length} selected):\n${bedsMatches.join('\n')}\n`;
            } else {
                result += `Beds Filter: ‚úì PASS (no filter)\n`;
            }
            
            // Test size filter
            if (sizeOptions.length > 0) {
                const sizeMatches = sizeOptions.map(range => {
                    const [min, max] = range.split('-').map(Number);
                    const match = listing.sqft_avg && listing.sqft_avg >= min && listing.sqft_avg <= max;
                    return `  ${range} sq ft: ${match ? '‚úì PASS' : '‚úó FAIL'}`;
                });
                result += `Size Filter (${sizeOptions.length} selected):\n${sizeMatches.join('\n')}\n`;
            } else {
                result += `Size Filter: ‚úì PASS (no filter)\n`;
            }
            
            // Test community filter
            if (communityOptions.length > 0) {
                const communityMatches = communityOptions.map(comm => {
                    const match = listing.community?.toLowerCase().includes(comm.toLowerCase());
                    return `  ${comm}: ${match ? '‚úì PASS' : '‚úó FAIL'}`;
                });
                result += `Community Filter (${communityOptions.length} selected):\n${communityMatches.join('\n')}\n`;
            } else {
                result += `Community Filter: ‚úì PASS (no filter)\n`;
            }
            
            // Test parking filter
            if (parkingOptions.length > 0) {
                const parkingStr = listing.parking_spots ? String(listing.parking_spots).toLowerCase() : '';
                const parkingMatches = parkingOptions.map(option => {
                    let match = false;
                    if (option === 'available') {
                        match = parkingStr && parkingStr !== 'none' && parkingStr !== 'n/a';
                    } else if (option === 'none') {
                        match = !parkingStr || parkingStr === 'none' || parkingStr === 'n/a';
                    } else if (option === '1') {
                        match = parkingStr && parkingStr.match(/1\s*(spot|vaga|space)/i);
                    } else if (option === '2') {
                        match = parkingStr && (parkingStr.match(/[2-9]\s*(spot|vaga|space)/i) || parkingStr.match(/\d+\s*(spot|vaga|space)/i));
                    }
                    return `  ${option}: ${match ? '‚úì PASS' : '‚úó FAIL'}`;
                });
                result += `Parking Filter (${parkingOptions.length} selected):\n${parkingMatches.join('\n')}\n`;
            } else {
                result += `Parking Filter: ‚úì PASS (no filter)\n`;
            }
            
            // Test furnished filter
            if (furnished) {
                const furnishedStr = listing.furnished ? String(listing.furnished).toLowerCase() : '';
                let match = false;
                if (furnished === 'yes') {
                    match = furnishedStr === 'yes';
                } else if (furnished === 'no') {
                    match = !furnishedStr || furnishedStr === 'no';
                }
                result += `Furnished Filter (${furnished}): ${match ? '‚úì PASS' : '‚úó FAIL'}\n`;
            } else {
                result += `Furnished Filter: ‚úì PASS (no filter)\n`;
            }
            
            // Test utilities filter
            if (utilitiesOptions.length > 0) {
                const utilitiesMatches = utilitiesOptions.map(utility => {
                    const match = listing.utilities_included && 
                           Array.isArray(listing.utilities_included) && 
                           listing.utilities_included.some(u => u.toLowerCase().includes(utility.toLowerCase()));
                    return `  ${utility}: ${match ? '‚úì PASS' : '‚úó FAIL'}`;
                });
                result += `Utilities Filter (${utilitiesOptions.length} selected):\n${utilitiesMatches.join('\n')}\n`;
            } else {
                result += `Utilities Filter: ‚úì PASS (no filter)\n`;
            }
            
            // Test amenities filter
            if (amenitiesOptions.length > 0) {
                const amenitiesMatches = amenitiesOptions.map(amenity => {
                    const match = listing.amenities && 
                           Array.isArray(listing.amenities) && 
                           listing.amenities.some(a => a.toLowerCase().includes(amenity.toLowerCase()));
                    return `  ${amenity}: ${match ? '‚úì PASS' : '‚úó FAIL'}`;
                });
                result += `Amenities Filter (${amenitiesOptions.length} selected):\n${amenitiesMatches.join('\n')}\n`;
            } else {
                result += `Amenities Filter: ‚úì PASS (no filter)\n`;
            }
            
            // Test immediate availability
            if (immediate) {
                const match = listing.immediately_available === 'Yes';
                result += `Immediate Availability: ${match ? '‚úì PASS' : '‚úó FAIL'}\n`;
            } else {
                result += `Immediate Availability: ‚úì PASS (not checked)\n`;
            }
            
            // Test pet friendly
            if (pets) {
                const match = listing.pet_friendly === true;
                result += `Pet Friendly: ${match ? '‚úì PASS' : '‚úó FAIL'}\n`;
            } else {
                result += `Pet Friendly: ‚úì PASS (not checked)\n`;
            }
            
            // Test best value
            if (value) {
                const match = listing.cost_per_sqft && listing.cost_per_sqft <= 1.5;
                result += `Best Value (<$1.50/sqft): ${match ? '‚úì PASS' : '‚úó FAIL'}\n`;
            } else {
                result += `Best Value: ‚úì PASS (not checked)\n`;
            }
            
            // Final verdict
            const inFilteredResults = filteredListings.some(l => l.link === listing.link);
            result += `\n=== FINAL VERDICT ===\n`;
            result += `Listing is ${inFilteredResults ? '‚úì IN' : '‚úó NOT IN'} filtered results\n`;
            
            output.textContent = result;
        }

        function updateStats(listings) {
            const immediate = listings.filter(l => l.immediately_available === 'Yes');
            const prices = listings.filter(l => l.price_avg).map(l => l.price_avg);
            const sizes = listings.filter(l => l.sqft_avg).map(l => l.sqft_avg);
            const costs = listings.filter(l => l.cost_per_sqft && l.cost_per_sqft < 100).map(l => l.cost_per_sqft);
            
            const percentage = listings.length > 0 ? Math.round((immediate.length / listings.length) * 100) : 0;

            document.getElementById('total-count').textContent = listings.length.toLocaleString();
            document.getElementById('stat-total-inline').textContent = listings.length.toLocaleString();
            document.getElementById('stat-percentage').textContent = percentage + '%';
            document.getElementById('help-total').textContent = listings.length.toLocaleString();
            document.getElementById('help-immediate').textContent = immediate.length.toLocaleString();
            document.getElementById('help-percentage').textContent = percentage + '%';
            
            document.getElementById('stat-avg-price').textContent = 
                prices.length ? `$${Math.round(prices.reduce((a,b) => a+b, 0) / prices.length).toLocaleString()}` : 'N/A';
            document.getElementById('stat-avg-size').textContent = 
                sizes.length ? Math.round(sizes.reduce((a,b) => a+b, 0) / sizes.length).toLocaleString() : 'N/A';
            document.getElementById('stat-avg-cost').textContent = 
                costs.length ? `$${(costs.reduce((a,b) => a+b, 0) / costs.length).toFixed(2)}` : 'N/A';
            document.getElementById('stat-immediate').textContent = immediate.length.toLocaleString();
        }

        function applyFilters() {
            // Get search text
            const searchText = document.getElementById('filter-search').value.toLowerCase().trim();
            
            // Get selected values from multi-select
            const cityOptions = Array.from(document.getElementById('filter-city').selectedOptions).map(o => o.value);
            const priceOptions = Array.from(document.getElementById('filter-price').selectedOptions).map(o => o.value);
            const bedsOptions = Array.from(document.getElementById('filter-beds').selectedOptions).map(o => o.value);
            const sizeOptions = Array.from(document.getElementById('filter-size').selectedOptions).map(o => o.value);
            const communityOptions = Array.from(document.getElementById('filter-community').selectedOptions).map(o => o.value);
            const parkingOptions = Array.from(document.getElementById('filter-parking').selectedOptions).map(o => o.value);
            const unitTypeOptions = Array.from(document.getElementById('filter-unit-type').selectedOptions).map(o => o.value);
            const utilitiesOptions = Array.from(document.getElementById('filter-utilities').selectedOptions).map(o => o.value);
            const amenitiesOptions = Array.from(document.getElementById('filter-amenities').selectedOptions).map(o => o.value);
            const carpetOptions = Array.from(document.getElementById('filter-carpet').selectedOptions).map(o => o.value);
            
            const immediate = document.getElementById('filter-immediate').checked;
            const pets = document.getElementById('filter-pets').checked;
            const value = document.getElementById('filter-value').checked;
            const longTerm = document.getElementById('filter-long-term').checked;
            const furnished = document.getElementById('filter-furnished').value;
            const sortBy = document.getElementById('sort-by').value;
            
            // Get operators for each individual filter
            const cityOp = document.querySelector('input[name="city-operator"]:checked')?.value || 'AND';
            const priceOp = document.querySelector('input[name="price-operator"]:checked')?.value || 'OR';
            const bedsOp = document.querySelector('input[name="beds-operator"]:checked')?.value || 'OR';
            const sizeOp = document.querySelector('input[name="size-operator"]:checked')?.value || 'OR';
            const communityOp = document.querySelector('input[name="community-operator"]:checked')?.value || 'AND';
            const parkingOp = document.querySelector('input[name="parking-operator"]:checked')?.value || 'OR';
            const unitTypeOp = document.querySelector('input[name="unittype-operator"]:checked')?.value || 'OR';
            const utilitiesOp = document.querySelector('input[name="utilities-operator"]:checked')?.value || 'AND';
            const amenitiesOp = document.querySelector('input[name="amenities-operator"]:checked')?.value || 'AND';
            const carpetOp = document.querySelector('input[name="carpet-operator"]:checked')?.value || 'OR';

            filteredListings = allListings.filter(listing => {
                // Search filter - searches in title
                let searchResult = true;
                if (searchText) {
                    const listingTitle = (listing.title || '').toLowerCase();
                    searchResult = listingTitle.includes(searchText);
                }

                // City filter (with individual operator)
                let cityResult = true;
                if (cityOptions.length > 0) {
                    const cityMatches = cityOptions.map(city => {
                        const listingCity = (listing.city || listing.city_code || '').toLowerCase();
                        return listingCity === city.toLowerCase();
                    });
                    cityResult = (cityOp === 'AND')
                        ? cityMatches.every(match => match)
                        : cityMatches.some(match => match);
                }

                // Price filter (with individual operator)
                let priceResult = true;
                if (priceOptions.length > 0) {
                    const priceMatches = priceOptions.map(range => {
                        const [min, max] = range.split('-').map(Number);
                        return (listing.price_avg && listing.price_avg >= min && listing.price_avg <= max);
                    });
                    priceResult = (priceOp === 'AND') 
                        ? priceMatches.every(match => match)
                        : priceMatches.some(match => match);
                }

                // Beds filter (with individual operator)
                let bedsResult = true;
                if (bedsOptions.length > 0) {
                    const bedsMatches = bedsOptions.map(bedOption => {
                        const bedCount = parseInt(bedOption);
                        if (bedCount === 4) {
                            return (listing.beds_num && listing.beds_num >= 4);
                        } else {
                            return (listing.beds_num === bedCount);
                        }
                    });
                    bedsResult = (bedsOp === 'AND')
                        ? bedsMatches.every(match => match)
                        : bedsMatches.some(match => match);
                }

                // Size filter (with individual operator)
                let sizeResult = true;
                if (sizeOptions.length > 0) {
                    const sizeMatches = sizeOptions.map(range => {
                        const [min, max] = range.split('-').map(Number);
                        return (listing.sqft_avg && listing.sqft_avg >= min && listing.sqft_avg <= max);
                    });
                    sizeResult = (sizeOp === 'AND')
                        ? sizeMatches.every(match => match)
                        : sizeMatches.some(match => match);
                }

                // Community filter (with individual operator)
                let communityResult = true;
                if (communityOptions.length > 0) {
                    const communityMatches = communityOptions.map(comm => 
                        (listing.community?.toLowerCase().includes(comm.toLowerCase()))
                    );
                    communityResult = (communityOp === 'AND')
                        ? communityMatches.every(match => match)
                        : communityMatches.some(match => match);
                }

                // Parking filter (with individual operator)
                let parkingResult = true;
                if (parkingOptions.length > 0) {
                    const parkingMatches = parkingOptions.map(option => {
                        const parkingSpots = listing.parking_spots || 0;
                        if (option === 'available') {
                            return (parkingSpots > 0);
                        } else if (option === 'none') {
                            return (parkingSpots === 0);
                        } else if (option === '1') {
                            return (parkingSpots === 1);
                        } else if (option === '2') {
                            return (parkingSpots === 2);
                        } else if (option === '3') {
                            return (parkingSpots === 3);
                        } else if (option === '4') {
                            return (parkingSpots === 4);
                        } else if (option === '5+') {
                            return (parkingSpots >= 5);
                        }
                        return false;
                    });
                    parkingResult = (parkingOp === 'AND')
                        ? parkingMatches.every(match => match)
                        : parkingMatches.some(match => match);
                }

                // Furnished filter (single select, no operator needed)
                let furnishedResult = true;
                if (furnished) {
                    const furnishedStr = listing.furnished ? String(listing.furnished).toLowerCase() : '';
                    if (furnished === 'yes') {
                        furnishedResult = furnishedStr === 'yes';
                    } else if (furnished === 'no') {
                        furnishedResult = !furnishedStr || furnishedStr === 'no';
                    }
                }

                // Carpet filter (multi-select with individual operator)
                let carpetResult = true;
                if (carpetOptions.length > 0) {
                    const hasFeatures = listing.features && Array.isArray(listing.features) && listing.features.length > 0;
                    const hasCarpet = hasFeatures && listing.features.includes('Carpeted Floors');
                    
                    const carpetMatches = carpetOptions.map(option => {
                        if (option === 'with') {
                            // Explicitly has "Carpeted Floors" in features array
                            return hasCarpet === true;
                        } else if (option === 'without') {
                            // Has features array but does NOT include "Carpeted Floors"
                            return hasFeatures && !hasCarpet;
                        } else if (option === 'not-mentioned') {
                            // No features array or empty features array (carpet not mentioned at all)
                            return !hasFeatures;
                        }
                        return false;
                    });
                    
                    carpetResult = (carpetOp === 'AND')
                        ? carpetMatches.every(match => match)
                        : carpetMatches.some(match => match);
                }

                // Unit Type filter (with individual operator)
                let unitTypeResult = true;
                if (unitTypeOptions.length > 0) {
                    const unitTypeMatches = unitTypeOptions.map(type => {
                        // Check the 'type' field which contains the actual unit type
                        const listingType = listing.type || '';
                        // Match exact type or if type contains comma-separated values
                        return listingType === type || listingType.includes(type);
                    });
                    unitTypeResult = (unitTypeOp === 'AND')
                        ? unitTypeMatches.every(match => match)
                        : unitTypeMatches.some(match => match);
                }

                // Utilities filter (with individual operator)
                let utilitiesResult = true;
                if (utilitiesOptions.length > 0) {
                    const utilitiesMatches = utilitiesOptions.map(utility => {
                        return (listing.utilities_included && 
                               Array.isArray(listing.utilities_included) && 
                               listing.utilities_included.includes(utility));
                    });
                    utilitiesResult = (utilitiesOp === 'AND')
                        ? utilitiesMatches.every(match => match)
                        : utilitiesMatches.some(match => match);
                }

                // Amenities filter (with individual operator)
                let amenitiesResult = true;
                if (amenitiesOptions.length > 0) {
                    const amenitiesMatches = amenitiesOptions.map(amenity => {
                        return (listing.amenities && 
                               Array.isArray(listing.amenities) && 
                               listing.amenities.includes(amenity));
                    });
                    amenitiesResult = (amenitiesOp === 'AND')
                        ? amenitiesMatches.every(match => match)
                        : amenitiesMatches.some(match => match);
                }

                // Quick filters (all must be met - always AND)
                let quickResult = true;
                if (immediate) {
                    quickResult = (quickResult && (listing.immediately_available === 'Yes'));
                }
                if (pets) {
                    quickResult = (quickResult && (listing.pet_friendly === true));
                }
                if (value) {
                    quickResult = (quickResult && (listing.cost_per_sqft && listing.cost_per_sqft <= 1.5));
                }
                if (longTerm) {
                    quickResult = (quickResult && (listing.lease_term && listing.lease_term.toLowerCase().includes('long term')));
                }

                // Location filter (radius-based) - use cached distance
                let locationResult = true;
                if (selectedLocation && listing._distance !== undefined) {
                    locationResult = (listing._distance <= selectedRadius);
                }

                // ALL filters must pass (AND between all filters)
                // Enclosing each filter result in parentheses for clarity (though not strictly necessary here)
                return (searchResult) && (cityResult) && (priceResult) && (bedsResult) && (sizeResult) && (communityResult) && 
                       (parkingResult) && (furnishedResult) && (carpetResult) && (unitTypeResult) && (utilitiesResult) && 
                       (amenitiesResult) && (quickResult) && (locationResult);
            });

            // Log filter results to console
            console.group('üîç Filter Results');
            console.log('Total listings:', allListings.length);
            console.log('Filtered listings:', filteredListings.length);
            
            // Debug carpet filter
            if (carpetOptions.length > 0) {
                const withCarpet = filteredListings.filter(l => {
                    const hasFeatures = l.features && Array.isArray(l.features) && l.features.length > 0;
                    return hasFeatures && l.features.includes('Carpeted Floors');
                }).length;
                const withoutCarpet = filteredListings.filter(l => {
                    const hasFeatures = l.features && Array.isArray(l.features) && l.features.length > 0;
                    const hasCarpet = hasFeatures && l.features.includes('Carpeted Floors');
                    return hasFeatures && !hasCarpet;
                }).length;
                const notMentioned = filteredListings.filter(l => {
                    const hasFeatures = l.features && Array.isArray(l.features) && l.features.length > 0;
                    return !hasFeatures;
                }).length;
                
                // Test AND/OR logic
                let logicExplanation = '';
                if (carpetOp === 'AND') {
                    logicExplanation = `AND logic: All ${carpetOptions.length} conditions must be TRUE (only listings matching ALL selected options)`;
                } else {
                    logicExplanation = `OR logic: Any of ${carpetOptions.length} conditions can be TRUE (listings matching ANY selected option)`;
                }
                
                console.log('üîç CARPET DEBUG:', {
                    selected: carpetOptions,
                    operator: carpetOp,
                    logic: logicExplanation,
                    'COM carpete (explicit)': withCarpet,
                    'SEM carpete (explicit)': withoutCarpet,
                    'N√ÉO mencionado (no features)': notMentioned,
                    total: withCarpet + withoutCarpet + notMentioned
                });
            }
            
            console.log('Active filters:', {
                search: searchText || 'none',
                city: cityOptions.length > 0 ? cityOptions : 'none',
                price: priceOptions.length > 0 ? priceOptions : 'none',
                beds: bedsOptions.length > 0 ? bedsOptions : 'none',
                size: sizeOptions.length > 0 ? sizeOptions : 'none',
                community: communityOptions.length > 0 ? communityOptions : 'none',
                parking: parkingOptions.length > 0 ? parkingOptions : 'none',
                furnished: furnished || 'none',
                carpet: carpetOptions.length > 0 ? carpetOptions : 'none',
                unitType: unitTypeOptions.length > 0 ? unitTypeOptions : 'none',
                utilities: utilitiesOptions.length > 0 ? utilitiesOptions : 'none',
                amenities: amenitiesOptions.length > 0 ? amenitiesOptions : 'none',
                immediate: immediate,
                pets: pets,
                value: value,
                longTerm: longTerm,
                location: selectedLocation ? `Radius: ${selectedRadius}km` : 'none'
            });
            console.log('Sort by:', sortBy);
            console.groupEnd();

            // Update active filters badge
            updateActiveFiltersBadge();

            // Sort
            filteredListings.sort((a, b) => {
                switch(sortBy) {
                    case 'cost_asc':
                        return (a.cost_per_sqft || 999) - (b.cost_per_sqft || 999);
                    case 'price_asc':
                        return (a.price_avg || 999999) - (b.price_avg || 999999);
                    case 'price_desc':
                        return (b.price_avg || 0) - (a.price_avg || 0);
                    case 'size_desc':
                        return (b.sqft_avg || 0) - (a.sqft_avg || 0);
                    case 'size_asc':
                        return (a.sqft_avg || 999999) - (b.sqft_avg || 999999);
                    case 'distance_asc':
                        // Sort by pre-calculated distance (cached in _distance property)
                        if (!selectedLocation) return 0;
                        return (a._distance || 999999) - (b._distance || 999999);
                    case 'date_desc':
                        return new Date(b.date || 0) - new Date(a.date || 0);
                    default:
                        return 0;
                }
            });

            displayListings();
        }

        function displayListings() {
            const container = document.getElementById('listings-container');
            const count = document.getElementById('results-count');
            
            count.textContent = filteredListings.length.toLocaleString();

            // Update community label with visible communities count
            updateCommunityLabel();

            if (filteredListings.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <div class="no-results-icon">üîç</div>
                        <h2>No listings found</h2>
                        <p>Try adjusting your filters</p>
                    </div>
                `;
                return;
            }

            // Show first 50 listings
            const displayListings = filteredListings.slice(0, 50);
            
            container.innerHTML = displayListings.map((listing, index) => `
                <div class="listing-card" 
                     data-lat="${listing.latitude || ''}" 
                     data-lng="${listing.longitude || ''}" 
                     data-title="${(listing.title || 'Rental Available').replace(/"/g, '&quot;')}"
                     data-index="${index}">
                    <img src="${listing.thumb || '/static/placeholder.png'}" 
                         alt="${listing.title || 'Rental'}" 
                         class="listing-image"
                         onerror="if(this.src!=='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2218%22 fill=%22%23999%22%3ENo Image%3C/text%3E%3C/svg%3E'){this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22300%22 height=%22200%22%3E%3Crect fill=%22%23ddd%22 width=%22300%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22sans-serif%22 font-size=%2218%22 fill=%22%23999%22%3ENo Image%3C/text%3E%3C/svg%3E';}">
                    
                    <div class="listing-details">
                        <div class="listing-title">${listing.title || 'Rental Available'}</div>
                        <div class="listing-address">
                            üìç ${listing.address || listing.community || 'Address not specified'}, ${listing.community || ''}
                        </div>
                        <div class="listing-specs">
                            ${listing.beds !== null ? `<span class="spec"><span class="spec-icon">üõèÔ∏è</span> ${listing.beds || 'Bachelor'} bed</span>` : ''}
                            ${listing.baths ? `<span class="spec"><span class="spec-icon">üöø</span> ${listing.baths} bath</span>` : ''}
                            ${listing.sqft_avg ? `<span class="spec"><span class="spec-icon">üìè</span> ${Math.round(listing.sqft_avg).toLocaleString()} sq ft</span>` : ''}
                            ${listing.parking_spots && listing.parking_spots > 0 ? `<span class="spec"><span class="spec-icon">üöó</span> ${listing.parking_spots} vaga${listing.parking_spots > 1 ? 's' : ''}</span>` : ''}
                            ${listing.cost_per_sqft && listing.cost_per_sqft < 100 ? `<span class="spec"><span class="spec-icon">üí∞</span> $${listing.cost_per_sqft.toFixed(2)}/sq ft</span>` : ''}
                            ${selectedLocation && listing._distance !== undefined && listing._distance < 999999 ? `<span class="spec" style="background: #e0e7ff; color: #4f46e5;"><span class="spec-icon">üìç</span> ${listing._distance.toFixed(3)} km</span>` : ''}
                        </div>
                        <div class="listing-tags">
                            ${listing.immediately_available === 'Yes' ? '<span class="tag tag-immediate">‚úì Available Now</span>' : ''}
                            ${listing.pet_friendly ? '<span class="tag tag-pet">üêæ Pet Friendly</span>' : ''}
                            ${listing.cost_per_sqft && listing.cost_per_sqft < 1.5 ? '<span class="tag tag-value">‚≠ê Best Value</span>' : ''}
                            ${listing.furnished && listing.furnished === 'Furnished' ? '<span class="tag" style="background: #fce7f3; color: #be185d;">üõãÔ∏è Furnished</span>' : ''}
                            ${listing.furnished && listing.furnished === 'Unfurnished' ? '<span class="tag" style="background: #f3f4f6; color: #6b7280;">üì¶ Unfurnished</span>' : ''}
                            ${listing.lease_term ? `<span class="tag" style="background: #e0f2fe; color: #0369a1;">üìÖ ${listing.lease_term}</span>` : ''}
                        </div>
                        ${listing.utilities_included && listing.utilities_included.length > 0 ? `
                        <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
                            <strong>Utilidades:</strong> ${listing.utilities_included.slice(0, 3).map(u => u.charAt(0).toUpperCase() + u.slice(1)).join(', ')}${listing.utilities_included.length > 3 ? ' +' + (listing.utilities_included.length - 3) : ''}
                        </div>
                        ` : ''}
                        ${listing.amenities && listing.amenities.length > 0 ? `
                        <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                            <strong>Comodidades:</strong> ${listing.amenities.slice(0, 4).map(a => a.charAt(0).toUpperCase() + a.slice(1)).join(', ')}${listing.amenities.length > 4 ? ' +' + (listing.amenities.length - 4) : ''}
                        </div>
                        ` : ''}
                    </div>
                    
                    <div class="listing-price">
                        <div class="price-main">$${listing.price_avg ? Math.round(listing.price_avg).toLocaleString() : listing.price || 'Call'}</div>
                        <div class="price-detail">per month</div>
                        ${listing.latitude && listing.longitude ? `
                        <button class="view-btn" style="background: #00a389; margin-bottom: 8px; border: none; cursor: pointer; width: 100%;" onclick="setLocationMarker(${listing.latitude}, ${listing.longitude}); map.setView([${listing.latitude}, ${listing.longitude}], 15); document.getElementById('map').scrollIntoView({ behavior: 'smooth', block: 'center' });">
                            üéØ Point of Interest
                        </button>
                        ` : ''}
                        <a href="${listing.link}" target="_blank" class="view-btn">View Details ‚Üí</a>
                    </div>
                </div>
            `).join('');

            if (filteredListings.length > 50) {
                container.innerHTML += `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        Showing 50 of ${filteredListings.length.toLocaleString()} results. Refine your search to see more specific listings.
                    </div>
                `;
            }

            // Add hover event listeners to all cards
            const cards = container.querySelectorAll('.listing-card');
            cards.forEach(card => {
                const lat = parseFloat(card.dataset.lat);
                const lng = parseFloat(card.dataset.lng);
                const title = card.dataset.title;

                if (lat && lng) {
                    // Show marker on hover
                    card.addEventListener('mouseenter', () => {
                        showHoverMarker(lat, lng, title);
                    });

                    // Remove marker when mouse leaves
                    card.addEventListener('mouseleave', () => {
                        removeHoverMarker();
                    });
                }
            });
        }

        function clearIndividualFilter(filterId) {
            const element = document.getElementById(filterId);
            if (!element) return;
            
            // Handle different input types
            if (element.tagName === 'SELECT') {
                if (element.multiple) {
                    // Multi-select: deselect all options
                    element.selectedIndex = -1;
                } else {
                    // Single select: reset to first/empty option
                    element.value = '';
                }
            } else if (element.tagName === 'INPUT') {
                if (element.type === 'checkbox') {
                    element.checked = false;
                } else {
                    element.value = '';
                }
            }
            
            // Show feedback with filter name
            const filterNames = {
                'filter-search': 'Busca',
                'filter-city': 'Cidades',
                'filter-price': 'Pre√ßo',
                'filter-beds': 'Quartos',
                'filter-size': 'Tamanho',
                'filter-community': 'Comunidade',
                'filter-parking': 'Estacionamento',
                'filter-furnished': 'Mobiliado',
                'filter-carpet': 'Carpete',
                'filter-unit-type': 'Tipo de Propriedade',
                'filter-utilities': 'Utilidades',
                'filter-amenities': 'Comodidades'
            };
            
            const name = filterNames[filterId] || 'Filtro';
            showClearFeedback(`${name} limpo`);
            applyFilters();
        }

        function clearSearchFilter() {
            document.getElementById('filter-search').value = '';
            showClearFeedback('Busca limpa');
            applyFilters();
        }

        function clearCityFilter() {
            document.getElementById('filter-city').selectedIndex = -1;
            document.getElementById('city-and').checked = true;
            showClearFeedback('Filtro de Cidade limpo');
            applyFilters();
        }

        function clearBasicFilters() {
            document.getElementById('filter-price').selectedIndex = -1;
            document.getElementById('filter-beds').selectedIndex = -1;
            document.getElementById('filter-size').selectedIndex = -1;
            document.getElementById('filter-community').selectedIndex = -1;
            // Reset individual operators to default
            document.getElementById('price-or').checked = true; // OR is default
            document.getElementById('beds-or').checked = true; // OR is default
            document.getElementById('size-or').checked = true; // OR is default
            document.getElementById('community-and').checked = true;
            showClearFeedback('Filtros B√°sicos limpos');
            applyFilters();
        }

        function clearFeaturesFilters() {
            document.getElementById('filter-parking').selectedIndex = -1;
            document.getElementById('filter-furnished').value = '';
            document.getElementById('filter-unit-type').selectedIndex = -1;
            document.getElementById('filter-utilities').selectedIndex = -1;
            document.getElementById('filter-amenities').selectedIndex = -1;
            // Reset individual operators to default
            document.getElementById('parking-or').checked = true; // OR is default
            document.getElementById('unittype-or').checked = true; // OR is default
            document.getElementById('utilities-and').checked = true;
            document.getElementById('amenities-and').checked = true;
            showClearFeedback('Caracter√≠sticas da Propriedade limpas');
            applyFilters();
        }

        function clearQuickFilters() {
            document.getElementById('filter-immediate').checked = false;
            document.getElementById('filter-pets').checked = false;
            document.getElementById('filter-value').checked = false;
            document.getElementById('filter-long-term').checked = false;
            showClearFeedback('Filtros R√°pidos limpos');
            applyFilters();
        }

        function clearAllFilters() {
            // Clear search
            document.getElementById('filter-search').value = '';
            
            // Clear all multi-select options
            document.getElementById('filter-city').selectedIndex = -1;
            document.getElementById('filter-price').selectedIndex = -1;
            document.getElementById('filter-beds').selectedIndex = -1;
            document.getElementById('filter-size').selectedIndex = -1;
            document.getElementById('filter-community').selectedIndex = -1;
            document.getElementById('filter-parking').selectedIndex = -1;
            document.getElementById('filter-unit-type').selectedIndex = -1;
            document.getElementById('filter-utilities').selectedIndex = -1;
            document.getElementById('filter-amenities').selectedIndex = -1;
            
            // Clear single selects and checkboxes
            document.getElementById('filter-furnished').value = '';
            document.getElementById('filter-carpet').selectedIndex = -1;
            document.getElementById('filter-immediate').checked = false;
            document.getElementById('filter-pets').checked = false;
            document.getElementById('filter-value').checked = false;
            
            // Reset sort
            document.getElementById('sort-by').value = 'cost_asc';
            
            // Reset all individual operators to default
            document.getElementById('city-and').checked = true;
            document.getElementById('price-or').checked = true; // OR is default
            document.getElementById('beds-or').checked = true; // OR is default
            document.getElementById('size-or').checked = true; // OR is default
            document.getElementById('community-and').checked = true;
            document.getElementById('parking-or').checked = true; // OR is default
            document.getElementById('unittype-or').checked = true; // OR is default
            document.getElementById('utilities-and').checked = true;
            document.getElementById('amenities-and').checked = true;
            document.getElementById('carpet-or').checked = true; // OR is default
            
            // Clear location filter
            clearLocationFilter();
            
            showClearFeedback('‚ú® Todos os filtros foram removidos');
            applyFilters();
        }

        function showClearFeedback(message) {
            const badge = document.getElementById('active-filters-badge');
            badge.textContent = message;
            badge.style.display = 'block';
            badge.style.background = '#dcfce7';
            badge.style.color = '#16a34a';
            
            // Hide feedback after 2 seconds
            setTimeout(() => {
                updateActiveFiltersBadge();
            }, 2000);
        }

        // Keep resetFilters as alias for compatibility
        function resetFilters() {
            clearAllFilters();
        }

        function updateActiveFiltersBadge() {
            const priceOptions = document.getElementById('filter-price').selectedOptions.length;
            const bedsOptions = document.getElementById('filter-beds').selectedOptions.length;
            const sizeOptions = document.getElementById('filter-size').selectedOptions.length;
            const communityOptions = document.getElementById('filter-community').selectedOptions.length;
            const parkingOptions = document.getElementById('filter-parking').selectedOptions.length;
            const utilitiesOptions = document.getElementById('filter-utilities').selectedOptions.length;
            const amenitiesOptions = document.getElementById('filter-amenities').selectedOptions.length;
            const carpetOptions = document.getElementById('filter-carpet').selectedOptions.length;
            const furnished = document.getElementById('filter-furnished').value ? 1 : 0;
            const immediate = document.getElementById('filter-immediate').checked ? 1 : 0;
            const pets = document.getElementById('filter-pets').checked ? 1 : 0;
            const value = document.getElementById('filter-value').checked ? 1 : 0;
            const longTerm = document.getElementById('filter-long-term').checked ? 1 : 0;
            
            const totalFilters = priceOptions + bedsOptions + sizeOptions + communityOptions + parkingOptions + utilitiesOptions + amenitiesOptions + carpetOptions + furnished + immediate + pets + value + longTerm;
            const badge = document.getElementById('active-filters-badge');
            
            if (totalFilters > 0) {
                badge.textContent = `üìä ${totalFilters} filtro(s) ativos`;
                badge.style.display = 'block';
                badge.style.background = '#dbeafe';
                badge.style.color = '#2563eb';
            } else {
                badge.textContent = '‚ú® Nenhum filtro ativo - Mostrando todos os resultados';
                badge.style.display = 'block';
                badge.style.background = '#f3f4f6';
                badge.style.color = '#6b7280';
            }
        }
        
        // Debug panel functions
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            const isVisible = panel.style.display !== 'none';
            
            if (isVisible) {
                panel.style.display = 'none';
            } else {
                panel.style.display = 'block';
                loadDebugInfo();
            }
        }
        
        async function loadDebugInfo() {
            const content = document.getElementById('debug-content');
            content.innerHTML = '<p style="text-align: center; color: #666;">Loading...</p>';
            
            try {
                const response = await fetch('/api/debug');
                const data = await response.json();
                
                content.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <!-- Dataset Info -->
                        <div style="border: 2px solid #00a389; border-radius: 10px; padding: 15px;">
                            <h3 style="color: #00a389; margin-bottom: 10px;">üì¶ Dataset</h3>
                            <p><strong>Total Entries:</strong> ${data.dataset.total_entries.toLocaleString()}</p>
                            <p><strong>Data Source:</strong> ${data.dataset.data_source}</p>
                            <p><strong>File Size:</strong> ${data.dataset.file_size_mb} MB</p>
                        </div>
                        
                        <!-- Data Completeness -->
                        <div style="border: 2px solid #10b981; border-radius: 10px; padding: 15px;">
                            <h3 style="color: #10b981; margin-bottom: 10px;">‚úÖ Data Completeness</h3>
                            <p><strong>Price:</strong> ${data.completeness.price.count.toLocaleString()} (${data.completeness.price.percent}%)</p>
                            <p><strong>Square Feet:</strong> ${data.completeness.sqft.count.toLocaleString()} (${data.completeness.sqft.percent}%)</p>
                            <p><strong>Bedrooms:</strong> ${data.completeness.beds.count.toLocaleString()} (${data.completeness.beds.percent}%)</p>
                            <p><strong>Bathrooms:</strong> ${data.completeness.baths.count.toLocaleString()} (${data.completeness.baths.percent}%)</p>
                        </div>
                        
                        <!-- Price Stats -->
                        <div style="border: 2px solid #ef4444; border-radius: 10px; padding: 15px;">
                            <h3 style="color: #ef4444; margin-bottom: 10px;">üí∞ Price Stats</h3>
                            <p><strong>Count:</strong> ${data.price_stats.count.toLocaleString()}</p>
                            <p><strong>Min:</strong> $${data.price_stats.min ? data.price_stats.min.toLocaleString() : 'N/A'}</p>
                            <p><strong>Max:</strong> $${data.price_stats.max ? data.price_stats.max.toLocaleString() : 'N/A'}</p>
                            <p><strong>Average:</strong> $${data.price_stats.avg ? data.price_stats.avg.toLocaleString() : 'N/A'}</p>
                            <p><strong>Median:</strong> $${data.price_stats.median ? data.price_stats.median.toLocaleString() : 'N/A'}</p>
                        </div>
                        
                        <!-- Size Stats -->
                        <div style="border: 2px solid #8b5cf6; border-radius: 10px; padding: 15px;">
                            <h3 style="color: #8b5cf6; margin-bottom: 10px;">üìè Size Stats</h3>
                            <p><strong>Count:</strong> ${data.size_stats.count.toLocaleString()}</p>
                            <p><strong>Min:</strong> ${data.size_stats.min ? data.size_stats.min.toLocaleString() : 'N/A'} sq ft</p>
                            <p><strong>Max:</strong> ${data.size_stats.max ? data.size_stats.max.toLocaleString() : 'N/A'} sq ft</p>
                            <p><strong>Average:</strong> ${data.size_stats.avg ? data.size_stats.avg.toLocaleString() : 'N/A'} sq ft</p>
                            <p><strong>Median:</strong> ${data.size_stats.median ? data.size_stats.median.toLocaleString() : 'N/A'} sq ft</p>
                        </div>
                        
                        <!-- Location -->
                        <div style="border: 2px solid #06b6d4; border-radius: 10px; padding: 15px;">
                            <h3 style="color: #06b6d4; margin-bottom: 10px;">üìç Location</h3>
                            <p><strong>Communities:</strong> ${data.location.unique_communities}</p>
                            <p><strong>Cities:</strong> ${data.location.unique_cities}</p>
                            <p><strong>Immediate Available:</strong> ${data.availability.immediate} (${data.availability.immediate_percent}%)</p>
                        </div>
                        
                        <!-- Pets -->
                        <div style="border: 2px solid #ec4899; border-radius: 10px; padding: 15px;">
                            <h3 style="color: #ec4899; margin-bottom: 10px;">üêæ Pet Friendly</h3>
                            <p><strong>Cats Allowed:</strong> ${data.pets.cats_allowed} (${data.pets.cats_percent}%)</p>
                            <p><strong>Dogs Allowed:</strong> ${data.pets.dogs_allowed} (${data.pets.dogs_percent}%)</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <h3 style="color: #00a389; margin-bottom: 10px;">üí° Data Quality Insights</h3>
                        <ul style="color: #666; line-height: 1.8;">
                            <li>‚úÖ <strong>${data.completeness.price.percent}%</strong> of listings have price information</li>
                            <li>‚úÖ <strong>${data.completeness.sqft.percent}%</strong> of listings have square footage data</li>
                            <li>‚úÖ Price range: <strong>$${data.price_stats.min ? data.price_stats.min.toLocaleString() : 'N/A'}</strong> to <strong>$${data.price_stats.max ? data.price_stats.max.toLocaleString() : 'N/A'}</strong></li>
                            <li>‚úÖ Average property size: <strong>${data.size_stats.avg ? data.size_stats.avg.toLocaleString() : 'N/A'} sq ft</strong></li>
                        </ul>
                    </div>
                `;
            } catch (error) {
                content.innerHTML = `<p style="color: #ef4444; text-align: center;">Error loading debug info: ${error.message}</p>`;
            }
        }

        // ========================================================================
        // SAVED FILTERS FUNCTIONALITY
        // ========================================================================

        // Get current filter state
        function getCurrentFilterState() {
            return {
                // Search
                search: document.getElementById('filter-search').value,
                
                // City
                city: Array.from(document.getElementById('filter-city').selectedOptions).map(o => o.value),
                cityOperator: document.querySelector('input[name="city-operator"]:checked').value,
                
                // Basic filters
                price: Array.from(document.getElementById('filter-price').selectedOptions).map(o => o.value),
                priceOperator: document.querySelector('input[name="price-operator"]:checked').value,
                beds: Array.from(document.getElementById('filter-beds').selectedOptions).map(o => o.value),
                bedsOperator: document.querySelector('input[name="beds-operator"]:checked').value,
                size: Array.from(document.getElementById('filter-size').selectedOptions).map(o => o.value),
                sizeOperator: document.querySelector('input[name="size-operator"]:checked').value,
                community: Array.from(document.getElementById('filter-community').selectedOptions).map(o => o.value),
                communityOperator: document.querySelector('input[name="community-operator"]:checked').value,
                
                // Property features
                parking: Array.from(document.getElementById('filter-parking').selectedOptions).map(o => o.value),
                parkingOperator: document.querySelector('input[name="parking-operator"]:checked').value,
                furnished: document.getElementById('filter-furnished').value,
                carpet: Array.from(document.getElementById('filter-carpet').selectedOptions).map(o => o.value),
                carpetOperator: document.querySelector('input[name="carpet-operator"]:checked').value,
                unitType: Array.from(document.getElementById('filter-unit-type').selectedOptions).map(o => o.value),
                unitTypeOperator: document.querySelector('input[name="unittype-operator"]:checked').value,
                utilities: Array.from(document.getElementById('filter-utilities').selectedOptions).map(o => o.value),
                utilitiesOperator: document.querySelector('input[name="utilities-operator"]:checked').value,
                amenities: Array.from(document.getElementById('filter-amenities').selectedOptions).map(o => o.value),
                amenitiesOperator: document.querySelector('input[name="amenities-operator"]:checked').value,
                
                // Quick filters
                immediate: document.getElementById('filter-immediate').checked,
                pets: document.getElementById('filter-pets').checked,
                value: document.getElementById('filter-value').checked,
                longTerm: document.getElementById('filter-long-term').checked
            };
        }

        // Apply filter state
        function applyFilterState(state) {
            // Search
            document.getElementById('filter-search').value = state.search || '';
            
            // City
            const citySelect = document.getElementById('filter-city');
            Array.from(citySelect.options).forEach(option => {
                option.selected = state.city.includes(option.value);
            });
            if (state.cityOperator === 'OR') document.getElementById('city-or').checked = true;
            else document.getElementById('city-and').checked = true;
            
            // Price
            const priceSelect = document.getElementById('filter-price');
            Array.from(priceSelect.options).forEach(option => {
                option.selected = state.price.includes(option.value);
            });
            if (state.priceOperator === 'AND') document.getElementById('price-and').checked = true;
            else document.getElementById('price-or').checked = true; // OR is default
            
            // Beds
            const bedsSelect = document.getElementById('filter-beds');
            Array.from(bedsSelect.options).forEach(option => {
                option.selected = state.beds.includes(option.value);
            });
            if (state.bedsOperator === 'AND') document.getElementById('beds-and').checked = true;
            else document.getElementById('beds-or').checked = true; // OR is default
            
            // Size
            const sizeSelect = document.getElementById('filter-size');
            Array.from(sizeSelect.options).forEach(option => {
                option.selected = state.size.includes(option.value);
            });
            if (state.sizeOperator === 'AND') document.getElementById('size-and').checked = true;
            else document.getElementById('size-or').checked = true; // OR is default
            
            // Community
            const communitySelect = document.getElementById('filter-community');
            Array.from(communitySelect.options).forEach(option => {
                option.selected = state.community.includes(option.value);
            });
            if (state.communityOperator === 'OR') document.getElementById('community-or').checked = true;
            else document.getElementById('community-and').checked = true;
            
            // Parking
            const parkingSelect = document.getElementById('filter-parking');
            Array.from(parkingSelect.options).forEach(option => {
                option.selected = state.parking.includes(option.value);
            });
            if (state.parkingOperator === 'AND') document.getElementById('parking-and').checked = true;
            else document.getElementById('parking-or').checked = true; // OR is default
            
            // Furnished
            document.getElementById('filter-furnished').value = state.furnished || '';
            
            // Carpet
            const carpetSelect = document.getElementById('filter-carpet');
            Array.from(carpetSelect.options).forEach(option => {
                option.selected = state.carpet && state.carpet.includes(option.value);
            });
            if (state.carpetOperator === 'AND') document.getElementById('carpet-and').checked = true;
            else document.getElementById('carpet-or').checked = true; // OR is default
            
            // Unit Type
            const unitTypeSelect = document.getElementById('filter-unit-type');
            Array.from(unitTypeSelect.options).forEach(option => {
                option.selected = state.unitType.includes(option.value);
            });
            if (state.unitTypeOperator === 'AND') document.getElementById('unittype-and').checked = true;
            else document.getElementById('unittype-or').checked = true;
            
            // Utilities
            const utilitiesSelect = document.getElementById('filter-utilities');
            Array.from(utilitiesSelect.options).forEach(option => {
                option.selected = state.utilities.includes(option.value);
            });
            if (state.utilitiesOperator === 'OR') document.getElementById('utilities-or').checked = true;
            else document.getElementById('utilities-and').checked = true;
            
            // Amenities
            const amenitiesSelect = document.getElementById('filter-amenities');
            Array.from(amenitiesSelect.options).forEach(option => {
                option.selected = state.amenities.includes(option.value);
            });
            if (state.amenitiesOperator === 'OR') document.getElementById('amenities-or').checked = true;
            else document.getElementById('amenities-and').checked = true;
            
            // Quick filters
            document.getElementById('filter-immediate').checked = state.immediate || false;
            document.getElementById('filter-pets').checked = state.pets || false;
            document.getElementById('filter-value').checked = state.value || false;
            document.getElementById('filter-long-term').checked = state.longTerm !== undefined ? state.longTerm : false;
            
            // Apply filters
            applyFilters();
        }

        // Save current filter
        function saveCurrentFilter() {
            const nameInput = document.getElementById('save-filter-name');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Por favor, digite um nome para o filtro.');
                return;
            }
            
            // Get current filter state
            const filterState = getCurrentFilterState();
            
            // Get saved filters from localStorage
            let savedFilters = JSON.parse(localStorage.getItem('rentfaster_saved_filters') || '{}');
            
            // Save the filter
            savedFilters[name] = {
                state: filterState,
                savedAt: new Date().toISOString()
            };
            
            localStorage.setItem('rentfaster_saved_filters', JSON.stringify(savedFilters));
            
            // Clear input and update dropdown
            nameInput.value = '';
            updateSavedFiltersDropdown();
            
            showClearFeedback(`Filtro "${name}" salvo com sucesso! ‚úÖ`);
        }

        // Load saved filter
        function loadSavedFilter() {
            const dropdown = document.getElementById('saved-filters-dropdown');
            const selectedName = dropdown.value;
            
            if (!selectedName) return;
            
            // Get saved filters
            const savedFilters = JSON.parse(localStorage.getItem('rentfaster_saved_filters') || '{}');
            
            if (savedFilters[selectedName]) {
                applyFilterState(savedFilters[selectedName].state);
                showClearFeedback(`Filtro "${selectedName}" carregado! ‚úÖ`);
            }
        }

        // Delete saved filter
        function deleteSavedFilter() {
            const dropdown = document.getElementById('saved-filters-dropdown');
            const selectedName = dropdown.value;
            
            if (!selectedName) {
                alert('Por favor, selecione um filtro para deletar.');
                return;
            }
            
            if (!confirm(`Tem certeza que deseja deletar o filtro "${selectedName}"?`)) {
                return;
            }
            
            // Get saved filters
            let savedFilters = JSON.parse(localStorage.getItem('rentfaster_saved_filters') || '{}');
            
            // Delete the filter
            delete savedFilters[selectedName];
            
            localStorage.setItem('rentfaster_saved_filters', JSON.stringify(savedFilters));
            
            // Update dropdown
            updateSavedFiltersDropdown();
            
            showClearFeedback(`Filtro "${selectedName}" deletado! üóëÔ∏è`);
        }

        // Update saved filters dropdown
        function updateSavedFiltersDropdown() {
            const dropdown = document.getElementById('saved-filters-dropdown');
            const countLabel = document.getElementById('saved-filters-count');
            
            // Get saved filters
            const savedFilters = JSON.parse(localStorage.getItem('rentfaster_saved_filters') || '{}');
            const filterNames = Object.keys(savedFilters).sort();
            
            // Clear dropdown
            dropdown.innerHTML = '<option value="">-- Selecione um filtro --</option>';
            
            // Add filters to dropdown
            filterNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                const savedAt = new Date(savedFilters[name].savedAt);
                option.textContent = `${name} (${savedAt.toLocaleDateString()})`;
                dropdown.appendChild(option);
            });
            
            // Update count
            if (filterNames.length === 0) {
                countLabel.textContent = 'Nenhum filtro salvo';
            } else if (filterNames.length === 1) {
                countLabel.textContent = '1 filtro salvo';
            } else {
                countLabel.textContent = `${filterNames.length} filtros salvos`;
            }
        }

        // Initialize saved filters on page load
        setTimeout(() => {
            updateSavedFiltersDropdown();
        }, 500);

    </script>
</body>
</html>
